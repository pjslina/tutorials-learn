import os
from openpyxl import Workbook, load_workbook

def write_or_update_excel(filepath, sheetname, listA, key_column_name="编号"):
    # 如果文件存在，则加载，否则新建
    if os.path.exists(filepath):
        wb = load_workbook(filepath)
        if sheetname in wb.sheetnames:
            ws = wb[sheetname]
        else:
            ws = wb.create_sheet(sheetname)
    else:
        wb = Workbook()
        ws = wb.active
        ws.title = sheetname

    # 获取表头（列名） -> 如果表是空的，写入列名
    if ws.max_row == 1 and ws.max_column == 1 and ws.cell(row=1, column=1).value is None:
        headers = list(listA[0].keys())
        for col_idx, header in enumerate(headers, start=1):
            ws.cell(row=1, column=col_idx, value=header)
    else:
        headers = [ws.cell(row=1, column=i).value for i in range(1, ws.max_column + 1)]

    # 构建编号 -> 行号的映射（用于后续查找）
    key_to_row = {}
    for row_idx in range(2, ws.max_row + 1):
        key = ws.cell(row=row_idx, column=headers.index(key_column_name) + 1).value
        if key is not None:
            key_to_row[key] = row_idx

    # 写入或更新数据
    for item in listA:
        key = item.get(key_column_name)
        if key is None:
            continue  # 跳过没有编号的数据
        if key in key_to_row:
            # 已存在，检查是否需要更新
            row_idx = key_to_row[key]
            for col_name, value in item.items():
                if col_name in headers:
                    col_idx = headers.index(col_name) + 1
                    cell_value = ws.cell(row=row_idx, column=col_idx).value
                    if cell_value != value:
                        ws.cell(row=row_idx, column=col_idx, value=value)
        else:
            # 新增一行
            new_row_idx = ws.max_row + 1
            for col_name in headers:
                if col_name in item:
                    col_idx = headers.index(col_name) + 1
                    ws.cell(row=new_row_idx, column=col_idx, value=item[col_name])

    # 保存文件
    wb.save(filepath)
    print(f"✅ 数据已成功写入或更新：{filepath} 的 sheet《{sheetname}》")

# 模拟 ListA 数据，每个字典代表一行
listA = [
    {"编号": 1001, "姓名": "张三", "年龄": 28},
    {"编号": 1002, "姓名": "李四", "年龄": 30},
    {"编号": 1003, "姓名": "王五", "年龄": 25},
]

file_path = "E:/xml_docs/员工信息.xlsx"
sheet_name = "员工数据"

write_or_update_excel(file_path, sheet_name, listA)
